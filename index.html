<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageTriage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .input-container {
            margin-bottom: 10px;
        }
        .folder-name {
            font-weight: bold;
        }
        #photo-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .photo {
            max-width: 45%;
            height: auto;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ImageTriage</h1>

        <div class="input-container">
            <label for="source-folder">Select Source Folder:</label>
            <input type="file" id="source-folder" webkitdirectory directory multiple>
            <span id="source-folder-name" class="folder-name"></span>
        </div>

        <div class="input-container">
            <label for="bg-removal-folder">Select Background Removal Folder:</label>
            <input type="file" id="bg-removal-folder" webkitdirectory directory multiple>
            <span id="bg-removal-folder-name" class="folder-name"></span>
        </div>

        <div class="input-container">
            <label for="dest-folder">Select Destination Folder:</label>
            <input type="file" id="dest-folder" webkitdirectory directory multiple>
            <span id="dest-folder-name" class="folder-name"></span>
        </div>

        <div id="status"></div>

        <div id="photo-container">
            <img id="original-photo" class="photo fade-in" alt="Original photo">
            <img id="bg-removal-photo" class="photo fade-in" alt="Background removed photo">
        </div>

        <div class="button-container">
            <button id="previous-button">Previous</button>
            <button id="next-button">Next</button>
        </div>

        <div class="button-container">
            <button id="move-button">Move</button>
        </div>
    </div>

    <script>
        let sourceFiles = [];
        let bgRemovalFiles = [];
        let currentIndex = 0;
        let destFolder;

        const sourceFolderInput = document.getElementById('source-folder');
        const bgRemovalFolderInput = document.getElementById('bg-removal-folder');
        const destFolderInput = document.getElementById('dest-folder');
        const sourceFolderName = document.getElementById('source-folder-name');
        const bgRemovalFolderName = document.getElementById('bg-removal-folder-name');
        const destFolderName = document.getElementById('dest-folder-name');
        const statusElement = document.getElementById('status');
        const originalPhoto = document.getElementById('original-photo');
        const bgRemovalPhoto = document.getElementById('bg-removal-photo');
        const previousButton = document.getElementById('previous-button');
        const nextButton = document.getElementById('next-button');
        const moveButton = document.getElementById('move-button');

        sourceFolderInput.addEventListener('change', handleSourceFolderSelect);
        bgRemovalFolderInput.addEventListener('change', handleBgRemovalFolderSelect);
        destFolderInput.addEventListener('change', handleDestFolderSelect);
        previousButton.addEventListener('click', showPreviousImage);
        nextButton.addEventListener('click', showNextImage);
        moveButton.addEventListener('click', moveCurrentImage);

        async function handleSourceFolderSelect() {
            const dirHandle = await window.showDirectoryPicker();
            sourceFiles = [];
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file' && entry.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                    sourceFiles.push(entry);
                }
            }
            sourceFolderName.textContent = dirHandle.name;
            updateStatus();
            showCurrentImage();
        }

        async function handleBgRemovalFolderSelect() {
            const dirHandle = await window.showDirectoryPicker();
            bgRemovalFiles = [];
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file' && entry.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                    bgRemovalFiles.push(entry);
                }
            }
            bgRemovalFolderName.textContent = dirHandle.name;
            updateStatus();
            showCurrentImage();
        }

        async function handleDestFolderSelect() {
            destFolder = await window.showDirectoryPicker();
            destFolderName.textContent = destFolder.name;
            updateStatus();
        }

        function updateStatus() {
            statusElement.textContent = `${sourceFiles.length} images in source folder, ${bgRemovalFiles.length} images in background removal folder`;
        }

        async function showCurrentImage() {
            if (sourceFiles.length > 0 && bgRemovalFiles.length > 0) {
                const sourceFile = await sourceFiles[currentIndex].getFile();
                const bgRemovalFile = await bgRemovalFiles[currentIndex].getFile();

                originalPhoto.src = URL.createObjectURL(sourceFile);
                bgRemovalPhoto.src = URL.createObjectURL(bgRemovalFile);

                originalPhoto.onload = () => URL.revokeObjectURL(originalPhoto.src);
                bgRemovalPhoto.onload = () => URL.revokeObjectURL(bgRemovalPhoto.src);
            }
        }

        function showPreviousImage() {
            if (currentIndex > 0) {
                currentIndex--;
                showCurrentImage();
            }
        }

        function showNextImage() {
            if (currentIndex < sourceFiles.length - 1) {
                currentIndex++;
                showCurrentImage();
            }
        }

        async function moveCurrentImage() {
            if (bgRemovalFiles.length > 0 && destFolder) {
                try {
                    await moveFile(bgRemovalFiles[currentIndex], destFolder);

                    bgRemovalFiles.splice(currentIndex, 1);
                    sourceFiles.splice(currentIndex, 1);

                    if (currentIndex >= bgRemovalFiles.length) {
                        currentIndex = bgRemovalFiles.length - 1;
                    }

                    updateStatus();
                    showCurrentImage();
                } catch (error) {
                    console.error('Error moving file:', error);
                    statusElement.textContent = 'Error moving file';
                }
            }
        }

        async function moveFile(fileHandle, destFolderHandle) {
            try {
                const file = await fileHandle.getFile();
                const newHandle = await destFolderHandle.getFileHandle(fileHandle.name, { create: true });
                const writable = await newHandle.createWritable();
                await writable.write(file);
                await writable.close();
                await fileHandle.remove();
            } catch (err) {
                console.error('Error moving file:', err);
                throw err;
            }
        }
    </script>
</body>
</html>